# JWT 黑名單改進實作摘要

## 1. 概述

本文件概述了 MorningAI MVP 專案中 JWT 黑名單改進的實作細節。JWT 黑名單機制用於撤銷已發行的 JWT 令牌，以確保在用戶登出或令牌洩露等情況下，這些令牌無法再被使用，從而提升系統安全性。

## 2. 實作方法

JWT 黑名單的改進主要集中在利用 Upstash Redis REST API 進行令牌的有效管理和檢查。具體步驟如下：

### 2.1. Redis 整合 (`main.py`)

*   **Redis 連線**：應用程式透過 `requests` 函式庫與 Upstash Redis REST API 進行互動，而不是傳統的 Redis 客戶端。這需要配置 `UPSTASH_REDIS_REST_URL` 和 `UPSTASH_REDIS_REST_TOKEN` 環境變數。
*   **令牌黑名單檢查**：在 `check_if_token_in_blocklist` 函數中，使用 Redis 的 `EXISTS` 命令來檢查 JWT 的 `jti` (JWT ID) 是否存在於黑名單中。如果存在，則表示該令牌已被撤銷。
*   **令牌撤銷**：在 `logout` 函數中，使用 Redis 的 `SET` 命令將 JWT 的 `jti` 加入黑名單，並設定一個過期時間（例如 1 小時）。這確保了令牌在登出後立即失效，並在一段時間後自動從黑名單中移除。

### 2.2. JWT 黑名單改進點

*   **高可用性 (HA) 考量**：Upstash Redis 服務本身提供了高可用性，減少了單點故障的風險。
*   **即時令牌撤銷**：透過將 `jti` 立即寫入 Redis，實現了令牌的即時撤銷，這對於密碼更改等高風險事件至關重要。
*   **API 閘道層整合**：雖然目前的實作是在 Flask 應用層進行黑名單檢查，但未來可以考慮將此邏輯推送到 API 閘道層，以減輕後端服務的負擔並提高效率。

## 3. 測試

JWT 黑名單改進的測試是中期改進測試的一部分，確保了令牌撤銷機制的正確性。測試涵蓋了以下場景：

*   用戶登出後，其 JWT 令牌被成功加入黑名單。
*   已加入黑名單的令牌無法再用於存取受保護的資源。

## 4. 結論

透過利用 Upstash Redis REST API 實作 JWT 黑名單機制，MorningAI MVP 專案顯著增強了令牌管理的靈活性和安全性。這確保了在各種安全事件發生時，可以有效地撤銷 JWT 令牌，從而保護用戶帳戶和系統資源。
