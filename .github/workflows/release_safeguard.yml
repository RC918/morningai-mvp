name: Release Safeguard

on:
  push:
    tags:
      - 'v*.*.*'
      - 'hotfix-*'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy (bypass safeguards)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      tag_name:
        description: 'Tag to deploy (if not triggered by tag push)'
        required: false
        type: string

permissions:
  contents: read
  actions: read

jobs:
  safeguard_check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      should_deploy: ${{ steps.safeguard.outputs.should_deploy }}
      is_hotfix: ${{ steps.safeguard.outputs.is_hotfix }}
      deployment_strategy: ${{ steps.safeguard.outputs.deployment_strategy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Safeguard Analysis
        id: safeguard
        run: |
          # ç²å–ç•¶å‰æ¨™ç±¤
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
            if [ -z "$TAG_NAME" ]; then
              echo "âŒ Manual trigger requires tag_name input"
              exit 1
            fi
          else
            TAG_NAME="${{ github.ref_name }}"
          fi
          
          echo "Analyzing tag: $TAG_NAME"
          
          # æª¢æŸ¥æ˜¯å¦ç‚º hotfix
          IS_HOTFIX="false"
          if [[ "$TAG_NAME" =~ ^hotfix- ]]; then
            IS_HOTFIX="true"
            echo "ğŸ”¥ Hotfix deployment detected"
          fi
          
          # æª¢æŸ¥æ˜¯å¦å¼·åˆ¶éƒ¨ç½²
          FORCE_DEPLOY="${{ github.event.inputs.force_deploy }}"
          if [ "$FORCE_DEPLOY" = "true" ]; then
            echo "âš ï¸ Force deploy enabled - bypassing safeguards"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "is_hotfix=$IS_HOTFIX" >> $GITHUB_OUTPUT
            echo "deployment_strategy=force" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æª¢æŸ¥æœ€è¿‘çš„ CI ç‹€æ…‹
          echo "Checking recent CI status..."
          
          # ç²å–æœ€è¿‘çš„ commit
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "Latest commit: $COMMIT_SHA"
          
          # æª¢æŸ¥ CI ç‹€æ…‹ï¼ˆæ¨¡æ“¬ï¼Œå¯¦éš›æ‡‰è©²èª¿ç”¨ GitHub APIï¼‰
          # é€™è£¡æˆ‘å€‘å‡è¨­ CI å·²ç¶“é€šéï¼Œå› ç‚º release é€šå¸¸åœ¨ CI é€šéå¾Œè§¸ç™¼
          CI_STATUS="success"
          
          if [ "$CI_STATUS" != "success" ]; then
            echo "âŒ CI checks not passing - blocking deployment"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # æª¢æŸ¥æ˜¯å¦æœ‰ç ´å£æ€§è®Šæ›´
          echo "Checking for breaking changes..."
          
          # ç²å–ä¸Šä¸€å€‹æ¨™ç±¤
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Previous tag: $PREVIOUS_TAG"
            
            # æª¢æŸ¥æ˜¯å¦æœ‰è³‡æ–™åº«é·ç§»æ–‡ä»¶è®Šæ›´
            DB_CHANGES=$(git diff --name-only $PREVIOUS_TAG HEAD | grep -E "(migration|alembic|schema)" || true)
            
            if [ -n "$DB_CHANGES" ]; then
              echo "âš ï¸ Database migration detected:"
              echo "$DB_CHANGES"
              
              # å°æ–¼ hotfixï¼Œå…è¨±ç¹¼çºŒä½†è¨˜éŒ„è­¦å‘Š
              if [ "$IS_HOTFIX" = "true" ]; then
                echo "ğŸ”¥ Hotfix with DB changes - proceeding with caution"
                echo "deployment_strategy=hotfix_with_db" >> $GITHUB_OUTPUT
              else
                echo "deployment_strategy=normal_with_db" >> $GITHUB_OUTPUT
              fi
            else
              echo "âœ… No database changes detected"
              if [ "$IS_HOTFIX" = "true" ]; then
                echo "deployment_strategy=hotfix_safe" >> $GITHUB_OUTPUT
              else
                echo "deployment_strategy=normal_safe" >> $GITHUB_OUTPUT
              fi
            fi
          else
            echo "âš ï¸ No previous tag found - first release"
            echo "deployment_strategy=first_release" >> $GITHUB_OUTPUT
          fi
          
          # æª¢æŸ¥éƒ¨ç½²æ™‚é–“ï¼ˆé¿å…åœ¨é«˜å³°æ™‚æ®µéƒ¨ç½²é hotfixï¼‰
          CURRENT_HOUR=$(date -u +%H)
          if [ "$IS_HOTFIX" != "true" ] && [ "$CURRENT_HOUR" -ge 9 ] && [ "$CURRENT_HOUR" -le 17 ]; then
            echo "âš ï¸ Deployment during business hours (UTC 9-17) - consider scheduling"
            # ä¸é˜»æ­¢éƒ¨ç½²ï¼Œä½†è¨˜éŒ„è­¦å‘Š
          fi
          
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          echo "is_hotfix=$IS_HOTFIX" >> $GITHUB_OUTPUT

  pre_deployment_check:
    needs: safeguard_check
    if: needs.safeguard_check.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pre-deployment Health Check
        run: |
          echo "Performing pre-deployment health check..."
          
          # æª¢æŸ¥ç”Ÿç”¢ç’°å¢ƒç•¶å‰ç‹€æ…‹
          API_URL="${{ vars.API_URL || 'https://morningai-mvp.onrender.com' }}"
          WEB_URL="${{ vars.WEB_URL || 'https://morningai-mvp-web.vercel.app' }}"
          
          echo "Checking API health: $API_URL/health"
          if curl -f -s "$API_URL/health" > current_api_health.json; then
            echo "âœ… API is currently healthy"
            cat current_api_health.json
          else
            echo "âš ï¸ API is currently unhealthy - deployment may be risky"
            # å°æ–¼ hotfixï¼Œç¹¼çºŒéƒ¨ç½²ï¼›å°æ–¼æ­£å¸¸ç™¼å¸ƒï¼Œå¯èƒ½éœ€è¦äººå·¥ç¢ºèª
            if [ "${{ needs.safeguard_check.outputs.is_hotfix }}" != "true" ]; then
              echo "âŒ Blocking non-hotfix deployment due to unhealthy API"
              exit 1
            fi
          fi
          
          echo "Checking Web health: $WEB_URL"
          if curl -f -s -I "$WEB_URL" > /dev/null; then
            echo "âœ… Web is currently accessible"
          else
            echo "âš ï¸ Web is currently inaccessible"
          fi

      - name: Upload Pre-deployment Report
        uses: actions/upload-artifact@v4
        with:
          name: pre-deployment-report
          path: |
            current_api_health.json

  trigger_release:
    needs: [safeguard_check, pre_deployment_check]
    if: needs.safeguard_check.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Trigger Main Release Workflow
        run: |
          echo "ğŸš€ Triggering main release workflow..."
          echo "Deployment strategy: ${{ needs.safeguard_check.outputs.deployment_strategy }}"
          echo "Is hotfix: ${{ needs.safeguard_check.outputs.is_hotfix }}"
          
          # é€™è£¡å¯ä»¥è§¸ç™¼ä¸»è¦çš„ release.yml å·¥ä½œæµç¨‹
          # æˆ–è€…ç›´æ¥åœ¨é€™å€‹å·¥ä½œæµç¨‹ä¸­åŸ·è¡Œéƒ¨ç½²æ­¥é©Ÿ
          
          # è¨­ç½®éƒ¨ç½²åƒæ•¸
          if [ "${{ needs.safeguard_check.outputs.is_hotfix }}" = "true" ]; then
            echo "CONTINUE_ON_ERROR=true" >> $GITHUB_ENV
            echo "DEPLOYMENT_TIMEOUT=30" >> $GITHUB_ENV
          else
            echo "CONTINUE_ON_ERROR=false" >> $GITHUB_ENV
            echo "DEPLOYMENT_TIMEOUT=15" >> $GITHUB_ENV
          fi

      - name: Repository Dispatch to Release
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: safeguard-approved-release
          client-payload: |
            {
              "tag": "${{ github.ref_name }}",
              "is_hotfix": "${{ needs.safeguard_check.outputs.is_hotfix }}",
              "deployment_strategy": "${{ needs.safeguard_check.outputs.deployment_strategy }}",
              "continue_on_error": "${{ env.CONTINUE_ON_ERROR }}",
              "timeout_minutes": "${{ env.DEPLOYMENT_TIMEOUT }}"
            }

  post_deployment_monitor:
    needs: [safeguard_check, trigger_release]
    if: always() && needs.safeguard_check.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Post-deployment Monitoring
        run: |
          echo "Starting post-deployment monitoring..."
          
          # ç­‰å¾…éƒ¨ç½²å®Œæˆ
          sleep 120
          
          API_URL="${{ vars.API_URL || 'https://morningai-mvp.onrender.com' }}"
          WEB_URL="${{ vars.WEB_URL || 'https://morningai-mvp-web.vercel.app' }}"
          
          # é€£çºŒå¥åº·æª¢æŸ¥
          for i in {1..5}; do
            echo "Health check attempt $i/5"
            
            if curl -f -s "$API_URL/health" > health_check_$i.json; then
              echo "âœ… API health check $i passed"
            else
              echo "âŒ API health check $i failed"
              
              # å¦‚æœä¸æ˜¯ hotfix ä¸”é€£çºŒå¤±æ•—ï¼Œè§¸ç™¼å‘Šè­¦
              if [ "${{ needs.safeguard_check.outputs.is_hotfix }}" != "true" ] && [ $i -ge 3 ]; then
                echo "ğŸš¨ Multiple health check failures detected"
                # é€™è£¡å¯ä»¥è§¸ç™¼å›æ»¾æˆ–å‘Šè­¦
              fi
            fi
            
            sleep 30
          done

      - name: Upload Monitoring Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: post-deployment-monitoring
          path: |
            health_check_*.json
